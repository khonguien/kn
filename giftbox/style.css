/* --- CẤU HÌNH CƠ BẢN --- */
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    background-color: #99ec99;
    height: 100vh;
    display: grid;
    place-items: center;
    font-family: 'Segoe UI', sans-serif;
    overflow: hidden;
    /* Tự động chỉnh cỡ theo màn hình */
    font-size: calc(14px + (20 - 14) * (100vw - 320px) / (1280 - 320));
}

.box {
    position: relative;
    width: 18em;
    height: 18em;
    cursor: pointer;
    /* [MỚI] Thêm transition để hiệu ứng phóng to mượt mà */
    transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* Vị trí tuyệt đối cho các thành phần */
.box-tape, .box-tape-left, .box-tape-right, .box-tape-center,
.box-gifts, .box-gift-shadow, .box-gift, .box-star {
    position: absolute;
}

/* --- MÀU SẮC --- */
.box-tape-center, .box-tape-left, .box-tape-right { background-color: #cc2424; }

/* --- CẤU TRÚC NƠ (BOW) --- */
.box-tape {
    animation: bTape 1.5s ease-in-out infinite;
    bottom: 11em; left: 7.5em; width: 3em; height: 2em;
    transform-origin: 50% 230%; z-index: 20;
    /* Transition để hỗ trợ việc bay lên */
    transition: transform 0.5s ease-in-out;
}
.box-tape-center { border-radius: 1em; width: 100%; height: 100%; }
.box-tape-left, .box-tape-right { box-shadow: 0 0 0 0.7em #ee2e2e inset; top: 0.3em; width: 4em; height: 5em; z-index: -1; }
.box-tape-left::before, .box-tape-right::before { background-color: #ee2e2e; border-radius: inherit; content: ""; display: block; position: absolute; inset: 0; }
.box-tape-left { animation: bLeft 1.5s ease-in-out infinite; border-radius: 1.5em 0 3em 1em / 1.5em 0 3em 3.5em; right: calc(100% - 0.75em); transform: rotate(35deg); transform-origin: 100% 15%; }
.box-tape-left::before { clip-path: polygon(0 42%, 100% 12%, 100% 100%, 0 100%); }
.box-tape-right { animation: bRight 1.5s ease-in-out infinite; border-radius: 0 1.5em 1em 3em / 0 1.5em 3.5em 3em; left: calc(100% - 0.75em); transform: rotate(-35deg); transform-origin: 0% 15%; }
.box-tape-right::before { clip-path: polygon(0 12%, 100% 42%, 100% 100%, 0 100%); }

/* --- THÂN HỘP (BODY) & NẮP HỘP (LID) --- */
.box-gifts, .box-gift, .box-gift-shadow { transform-origin: 50% 100%; }

/* Thân hộp */
.box-gifts {
    animation: box-Bounce 1.5s ease-in-out infinite;
    background: linear-gradient(#cc2424, #cc2424) 50% 50% / 3.3em 100% no-repeat, #dfd9d9;
    border-radius: 1.5em; bottom: 0.5em; left: 3.3em; width: 11.4em; height: 9em;
    overflow: hidden; z-index: 10;
    transition: transform 0.5s ease-out;
}

/* Nắp hộp */
.box-gift {
    animation: box-Bounce2 1.5s ease infinite;
    background: linear-gradient(#ee2e2e, #ee2e2e) 50% 50%/ 3.3em 100% no-repeat, #efffee;
    bottom: 8.7em; left: 2.5em; width: 13em; height: 3.3em;
    border-radius: 1em; z-index: 15;
}

.box-gift-shadow {
    animation: boxShadowBounce 1.5s ease-in-out infinite;
    background-color: #00000010; top: -1.5em; left: -1em; width: 13em; height: 3.3em; border-radius: 1em;
    transition: opacity 0.3s;
}

/* --- NGÔI SAO --- */
.box-star { animation: starRotate1 1.5s ease-in-out infinite; background-color: #fcff50; clip-path: polygon(50% 0, 65% 35%, 100% 50%, 65% 65%, 50% 100%, 35% 65%, 0 50%, 35% 35%); transform: scale(0); }
.box-star-2, .box-star-4, .box-star-5 { animation-name: starRotate2; }
.box-star-1 { animation-delay: calc(1.5s * 0.5); top: 0; left: 12.5em; width: 1.5em; height: 1.5em; }
.box-star-2 { animation-delay: calc(1.5s * 0.125); top: 2em; left: 10em; width: 1.75em; height: 1.75em; }
.box-star-3 { animation-delay: calc(1.5s * 0.25); top: 8em; left: 0em; width: 1.25em; height: 1.25em; }
.box-star-4 { top: 10.5em; left: 0em; width: 1.75em; height: 1.75em; }
.box-star-5 { animation-delay: calc(1.5s * 0.375); top: 12em; left: 1.8em; width: 2.5em; height: 2.5em; }

/* --- LÁ THƯ (STYLE) --- */
.letter {
    position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
    width: 14em; height: 20em; background: #fff; border-radius: 0.5em; padding: 1.5em;
    box-shadow: 0 0.5em 1em rgba(0,0,0,0.1); z-index: 5; opacity: 0; overflow-y: auto; text-align: center;
}
.letter::-webkit-scrollbar { width: 4px; }
.letter::-webkit-scrollbar-thumb { background: #cc2424; border-radius: 10px; }
.letter hr { border: 0; border-top: 1px dashed #ccc; margin: 10px 0; }
.letter h2 { color: #cc2424; font-size: 1.2rem; margin-top: 0; }
.letter p { font-size: 0.9rem; color: #333; line-height: 1.5; text-align: justify; }


/* =========================================
   LOGIC KHI MỞ/ĐÓNG (CẬP NHẬT MỚI)
========================================= */

/* --- KHI MỞ (OPEN) --- */

/* 1. HỘP PHÓNG TO LÊN */
.box.open {
    transform: scale(1.3); /* Phóng to 1.3 lần */
}

/* 2. THÂN HỘP DỪNG NHÚN */
.box.open .box-gifts,
.box.open .box-gift-shadow {
    animation: none;
    transform: translateY(0) scale(1);
    transition-delay: 0.4s; /* Đợi phóng to xong mới dừng hẳn */
}
.box.open .box-gift-shadow { opacity: 0; }

/* 3. NẮP & NƠ BAY LÊN (CÓ DELAY) */
.box.open .box-gift,
.box.open .box-tape {
    animation: flyUp 0.8s forwards cubic-bezier(0.25, 1, 0.5, 1);
    /* [QUAN TRỌNG] Delay 0.5s: Đợi hộp phóng to xong (0.5s) mới mở nắp */
    animation-delay: 0.5s; 
}
.box.open .box-tape-left, .box.open .box-tape-right { animation: none; }

/* 4. LÁ THƯ BAY RA (CÓ DELAY) */
.box.open .letter {
    animation: letterUp 0.8s forwards cubic-bezier(0.25, 1, 0.5, 1);
    /* [QUAN TRỌNG] Delay 0.7s: Đợi nắp mở he hé (0.2s sau khi nắp bắt đầu) thì thư bay */
    animation-delay: 0.7s;
}

/* --- KHI ĐÓNG (CLOSE) --- */

/* 1. Thu nhỏ hộp lại về kích thước cũ */
.box.close-opt {
    transform: scale(1);
    /* Đợi thư chui vào và nắp đóng xong (khoảng 1.2s) mới thu nhỏ lại */
    transition-delay: 1.2s; 
}

/* 2. Thư chui xuống trước */
.box.close-opt .letter { animation: letterDown 0.6s forwards; }

/* 3. Nắp bay xuống sau */
.box.close-opt .box-gift,
.box.close-opt .box-tape {
    animation: flyDown 0.8s forwards cubic-bezier(0.25, 1, 0.5, 1);
    animation-delay: 0.5s; /* Đợi thư gần vào hết mới đóng */
}


/* =========================================
   KEYFRAMES
========================================= */
@keyframes bTape { from, 50% { transform: translateY(0) rotate(0); } 62.5% { transform: translateY(75%) rotate(0); } 68.75% { transform: translateY(-37.5%) rotate(15deg); } 75% { transform: translateY(-150%) rotate(5deg); } 87.5% { transform: translateY(65%) rotate(-3deg); } to { transform: translateY(0) rotate(0); } }
@keyframes bLeft { from, 50% { transform: rotate(35deg); } 62.5% { transform: rotate(45deg); } 75% { transform: rotate(30deg); } 87.5% { transform: rotate(45deg); } to { transform: rotate(35deg); } }
@keyframes bRight { from, 50% { transform: rotate(-35deg); } 62.5% { transform: rotate(-45deg); } 75% { transform: rotate(-35deg); } 87.5% { transform: rotate(-45deg); } to { transform: rotate(-35deg); } }
@keyframes box-Bounce { from, 50% { transform: translateY(0) scale(1, 1); } 62.5% { transform: translateY(4%) scale(1.12, 0.89); } 75% { transform: translateY(-11%) scale(0.92, 1.1); } 87.5% { transform: translateY(0) scale(1.05, 0.9); } to { transform: translateY(0) scale(1, 1); } }
@keyframes box-Bounce2 { from, 50% { transform: translateY(0) scale(1, 1) rotate(0); } 62.5% { animation-timing-function: ease-in; transform: translateY(45%) scale(1.14, 0.95) rotate(0); } 68.75% { animation-timing-function: ease-out; transform: translateY(-22.5%) scale(1.05, 1.03) rotate(15deg); } 75% { animation-timing-function: ease-out; transform: translateY(-90%) scale(0.96, 1.1) rotate(5deg); } 87.5% { transform: translateY(30%) scale(1.12, 0.93) rotate(-3deg); } to { transform: translateY(0) scale(1.1) rotate(0); } }
@keyframes boxShadowBounce { from, 50% { transform: translateY(0) scale(1, 1) rotate(0); } 62.5% { animation-timing-function: ease-in; transform: translateY(10%) scale(1.14, 0.95) rotate(0); } 68.75% { animation-timing-function: ease-out; transform: translateY(-10%) scale(1.05, 1.03) rotate(15deg); } 75% { animation-timing-function: ease-out; transform: translateY(-30%) scale(0.96, 1.1) rotate(5deg); } 87.5% { transform: translateY(10%) scale(1.12, 0.93) rotate(-3deg); } to { transform: translateY(0) scale(1.1) rotate(0); } }
@keyframes starRotate1 { from { transform: scale(0) rotate(0); } 25% { transform: scale(1) rotate(0.25turn); } 50%, 100% { transform: scale(0) rotate(0.5turn); } }
@keyframes starRotate2 { from { transform: scale(0) rotate(0); } 25% { transform: scale(1) rotate(-0.25turn); } 50%, 100% { transform: scale(0) rotate(-0.5turn); } }

/* KEYFRAMES MỚI */
@keyframes flyUp {
    0% { transform: translateY(0) rotate(0); }
    100% { transform: translateY(-14em) rotate(-10deg); }
}
@keyframes flyDown {
    0% { transform: translateY(-14em) rotate(-10deg); }
    100% { transform: translateY(0) rotate(0); }
}
@keyframes letterUp {
    0% { bottom: 0; opacity: 0; z-index: 1; }
    50% { bottom: 30em; opacity: 1; z-index: 5; }
    51% { z-index: 25; }
    100% { bottom: 2em; opacity: 1; z-index: 25; }
}
@keyframes letterDown {
    0% { bottom: 2em; opacity: 1; z-index: 25; }
    40% { bottom: 15em; opacity: 1; z-index: 25; }
    41% { z-index: 5; }
    100% { bottom: 0; opacity: 0; z-index: 5; }
}

/* MOBILE FIX */
@media screen and (max-width: 768px) {
    body { font-size: 16px; }
    .box { margin-top: 100px; }
    .letter { width: 70vw; height: 60vh; bottom: 0; padding: 20px; }
    .letter p { font-size: 14px; line-height: 1.6; }
    @keyframes letterUp {
        0% { bottom: 0; opacity: 0; z-index: 5; }
        50% { bottom: 120%; opacity: 1; z-index: 5; }
        51% { z-index: 25; }
        100% { bottom: 20px; opacity: 1; z-index: 25; }
    }
}